apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: external-dns
  namespace: external-dns
spec:
  releaseName: external-dns
  interval: 10m
  chart:
    spec:
      chart: external-dns
      version: 1.19.0
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        name: external-dns
        namespace: flux-system
  values:
    policy: sync
    sources:
    - ingress
    - service
    txtOwnerId: ${CLUSTER_NAME}

    provider:
      name: cloudflare

    extraArgs:
    - --cloudflare-dns-records-per-page=1000
    # The regular nginx class uses a wildcard DNS record, so isn't managed by external-dns
    - --ingress-class=nginx-cloudflare
    - --ingress-class=nginx-tailscale

    env:
    - name: CF_API_TOKEN
      valueFrom:
        secretKeyRef:
          name: cloudflare-api-token
          key: cloudflare_api_token
